<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
</head>
<body>

  <button data-type="direction" data-action="up">UP</button>
  <button data-type="direction" data-action="left">LEFT</button>
  <button data-type="direction" data-action="down">DOWN</button>
  <button data-type="direction" data-action="right">RIGHT</button>

  <button data-type="game-control" data-action="reset">reset</button>
  <button data-type="game-control" data-action="start">start</button>

  <p>Fruits: <span id="fruits-number">-</span></p>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    'use strict';

    var _slice = Function.prototype.call.bind(Array.prototype.slice);
    var $buttons = _slice(document.getElementsByTagName('button'));
    var $fruitsNumber = document.getElementById('fruits-number');

    var socket = io.connect(window.location.path, {
      transports: ['websocket']
    });

    var onButtonClick = function (e) {
      console.log(e.target.dataset);

      switch (e.target.dataset.type) {
        case 'direction':
          socket.emit('direction', {direction: e.target.dataset.action});
          break;

        case 'game-control':
          socket.emit('game-control', {control: e.target.dataset.action});
          break;

        default:
          console.warn('Oops, unhandled type of click!');
      }
    };

    var onGameStoreChanged = function (state) {
      $fruitsNumber.innerHTML = '' + state.fruits;
    };

    var onAppStoreChanged = function (state) {
      if (state.ctrl !== 'APP_CTRL_SNAKE')
        $buttons.forEach(function (button) { button.disabled = true; });
      else
        $buttons.forEach(function (button) { button.disabled = false; });
    };

    socket.on('connect', function () {
      console.log('connected');
      $buttons.forEach(function (button) {
        button.addEventListener('click', onButtonClick, false);
      });

      socket.on('change-AppStore', onAppStoreChanged);
      socket.on('change-GameStore', onGameStoreChanged);
    });

    socket.on('disconnect', function () {
      console.log('disconnected');
      $buttons.forEach(function (button) {
        button.removeEventListener('click', onButtonClick, false);
      });

      socket.removeListener('change-AppStore', onAppStoreChanged);
      socket.removeListener('change-GameStore', onGameStoreChanged);
    });
  </script>
</body>
</html>
